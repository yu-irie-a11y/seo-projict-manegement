<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>金光八尾中学校・高等学校 ページ役割・CVフロー図</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --cta:#c62828;
  --accent:#37474f;
  --bg:#eceef1;--card:#fff;--border:#d5d9e0;
  --sec-bg:#eef0f4;--sec-head:#dfe2e8;
  --text:#1a1a1a;--text-sub:#555;--text-muted:#8a8f99;
  --sidebar-bg:#1e272e;--sidebar-text:#dfe6ed;
  --f-知る:#5c7cfa;--f-気になる:#40c057;--f-比べる:#fab005;--f-安心する:#be4bdb;--f-申し込む:#e03131;
  --radius:8px;
}
body{font-family:'Hiragino Kaku Gothic ProN','Noto Sans JP',system-ui,sans-serif;background:var(--bg);color:var(--text);font-size:14px;line-height:1.7}
#app{display:flex;height:100vh;overflow:hidden}

/* ===== Sidebar ===== */
#sidebar{width:260px;min-width:260px;background:var(--sidebar-bg);color:var(--sidebar-text);display:flex;flex-direction:column;overflow:hidden}
#sidebar-header{padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.06)}
#sidebar-header h1{font-size:13px;font-weight:700}
#sidebar-header p{font-size:11px;color:rgba(255,255,255,.4);margin-top:2px}
#search-box{margin:8px 12px;position:relative}
#search-box input{width:100%;padding:7px 10px 7px 32px;border:none;border-radius:6px;background:rgba(255,255,255,.1);color:#fff;font-size:12px;outline:none}
#search-box input::placeholder{color:rgba(255,255,255,.35)}
#search-box .icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.4;font-size:12px}
#page-list{flex:1;overflow-y:auto;padding:4px 0}
#page-list::-webkit-scrollbar{width:3px}
#page-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:2px}
.tpl-group{margin-bottom:2px}
.tpl-header{padding:7px 14px;font-size:10.5px;font-weight:700;color:rgba(255,255,255,.4);letter-spacing:.5px;cursor:pointer;display:flex;align-items:center;gap:6px;user-select:none}
.tpl-header:hover{color:rgba(255,255,255,.6)}
.tpl-header .arrow{transition:transform .2s;font-size:9px}
.tpl-header.collapsed .arrow{transform:rotate(-90deg)}
.tpl-items{overflow:hidden;transition:max-height .3s ease}
.tpl-items.collapsed{max-height:0!important}
.pg-item{padding:6px 14px 6px 22px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .12s;border-left:3px solid transparent;color:rgba(255,255,255,.55)}
.pg-item:hover{background:rgba(255,255,255,.05);color:rgba(255,255,255,.9)}
.pg-item.active{background:rgba(255,255,255,.08);border-left-color:rgba(255,255,255,.6);color:#fff}
.pg-item .pg-num{font-size:10px;opacity:.35;min-width:20px;font-family:monospace}
.pg-item .pg-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.pg-item .f-dot{width:6px;height:6px;border-radius:50%;margin-left:auto;flex-shrink:0;opacity:.5}

/* ===== Main ===== */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#topbar{padding:12px 28px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px;flex-shrink:0}
#breadcrumb{font-size:13px;color:var(--text-sub);flex:1}
#breadcrumb b{color:var(--text)}
.legend{display:flex;gap:12px;font-size:10px;color:var(--text-muted)}
.legend .lg{display:flex;align-items:center;gap:3px}
.legend .lg-dot{width:7px;height:7px;border-radius:50%}
#content{flex:1;overflow-y:auto;padding:28px 36px}

/* ===== Page Header ===== */
.page-head{max-width:760px;margin-bottom:22px}
.page-head h2{font-size:20px;font-weight:800;color:var(--text);display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;line-height:1.4}
.page-head .url{font-size:11px;color:var(--text-muted);font-weight:400;font-family:'SF Mono',Menlo,monospace;background:#e8eaed;padding:2px 8px;border-radius:4px}
.page-head .meta{display:flex;flex-wrap:wrap;gap:5px;margin:8px 0 12px}
.badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:4px;font-size:10.5px;font-weight:600}
.badge-tpl{background:#e8eaed;color:var(--text-sub)}
.badge-funnel{color:#fff}
.badge-cv{background:var(--cta);color:#fff}
.badge-branch{background:#e8eaed;color:var(--text-sub)}
.role-box{font-size:13px;color:var(--text-sub);background:#f7f8fa;padding:12px 16px;border-radius:var(--radius);border-left:3px solid var(--accent)}
.role-box strong{color:var(--accent)}

/* ===== Filter Bar ===== */
.filter-bar{max-width:760px;margin-bottom:18px;display:flex;align-items:center;gap:10px}
.filter-bar label{font-size:11px;color:var(--text-muted);font-weight:600}
.filter-pills{display:flex;gap:0;background:#e0e3e8;border-radius:6px;overflow:hidden;padding:2px}
.filter-pill{padding:5px 14px;font-size:11.5px;font-weight:600;cursor:pointer;transition:all .15s;color:var(--text-sub);background:transparent;border-radius:4px;user-select:none}
.filter-pill:hover{background:rgba(255,255,255,.5)}
.filter-pill.active{background:#fff;color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.1)}
.filter-desc{font-size:10.5px;color:var(--text-muted)}

/* ===== Flow Summary ===== */
.flow-summary{max-width:760px;margin-bottom:18px;padding:14px 18px;background:#fff;border:1px solid var(--border);border-radius:var(--radius);font-size:12.5px;color:var(--text-sub);line-height:1.8}
.flow-summary .fs-label{font-size:10.5px;color:var(--text-muted);font-weight:600;margin-bottom:4px}
.flow-summary .fs-journey{display:flex;flex-wrap:wrap;align-items:center;gap:4px;margin-bottom:6px}
.flow-summary .fs-step{background:var(--sec-bg);padding:2px 8px;border-radius:4px;font-size:11.5px;font-weight:600;color:var(--text)}
.flow-summary .fs-arr{color:var(--text-muted);font-size:11px}
.flow-summary .fs-goal{background:#f9eaea;color:var(--cta);font-weight:700;padding:2px 8px;border-radius:4px;font-size:11.5px}
.flow-summary .fs-why{font-size:12px;color:var(--text-sub)}

/* ===== Branch Bar ===== */
.branch-bar{max-width:760px;margin-bottom:18px;background:#f7f8fa;border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px}
.branch-bar h4{font-size:11px;color:var(--text-muted);margin-bottom:8px;font-weight:600;letter-spacing:.03em}
.branch-tabs{display:flex;flex-wrap:wrap;gap:6px}
.branch-tab{padding:9px 16px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:12.5px;cursor:pointer;background:#fff;transition:all .15s;display:flex;flex-direction:column;gap:2px;min-width:130px}
.branch-tab:hover{border-color:#aab;background:#f5f6f8}
.branch-tab.active{border-color:var(--accent);background:var(--accent);color:#fff}
.branch-tab .bt-label{font-weight:700;color:inherit}
.branch-tab .bt-sub{font-size:10.5px;color:var(--text-muted)}
.branch-tab.active .bt-sub{color:rgba(255,255,255,.7)}

/* ===== Flow Timeline ===== */
.flow-box{max-width:760px}
.flow-title{font-size:13px;font-weight:700;color:var(--text-sub);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.flow-title .cnt{font-weight:500;font-size:11.5px;color:var(--text-muted);background:#e8eaed;padding:2px 8px;border-radius:4px}
.flow-tl{position:relative;padding-left:38px}
.flow-tl::before{content:'';position:absolute;left:17px;top:24px;bottom:24px;width:2px;background:#ccc;border-radius:1px}

/* Step */
.f-step{position:relative;margin-bottom:8px;opacity:0;transform:translateY(6px);animation:stepIn .3s ease forwards}
@keyframes stepIn{to{opacity:1;transform:translateY(0)}}
.f-step:last-child{margin-bottom:0}
.s-dot{position:absolute;left:-27px;top:17px;width:12px;height:12px;border-radius:50%;border:2.5px solid var(--bg);z-index:1}
.f-step.is-entry .s-dot{box-shadow:0 0 0 2.5px var(--accent)}
.f-step.is-cv .s-dot{box-shadow:0 0 0 2.5px var(--cta)}

/* Card */
.s-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:all .15s}
.f-step.is-entry .s-card{border-color:var(--accent)}
.f-step.is-cv .s-card{border-color:var(--cta)}

/* Header */
.s-header{padding:12px 16px;display:flex;align-items:center;gap:9px;cursor:pointer;user-select:none;transition:background .1s}
.s-header:hover{background:#f8f9fa}
.s-num{font-size:10.5px;color:#fff;font-weight:700;min-width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%;flex-shrink:0}
.s-name{font-weight:700;font-size:13.5px;flex:1;color:var(--text)}
.s-url{font-size:10.5px;color:var(--text-muted);font-family:'SF Mono',Menlo,monospace;background:#eef0f3;padding:2px 6px;border-radius:3px}
.entry-tag{padding:2px 7px;border-radius:3px;font-size:10px;font-weight:700;color:#fff;background:var(--accent)}
.cv-tag{padding:2px 7px;border-radius:3px;font-size:10px;font-weight:700;color:#fff;background:var(--cta)}
.s-toggle{font-size:10px;color:var(--text-muted);transition:transform .2s;width:18px;text-align:center}
.s-toggle.open{transform:rotate(180deg)}

/* Body */
.s-body{padding:0 16px 14px;display:none}
.s-body.open{display:block}
.s-funnel{margin-bottom:8px;display:flex;align-items:center;gap:8px}

/* Role in step */
.s-role{font-size:11.5px;color:var(--text-sub);padding:7px 10px;background:#f4f5f7;border-radius:5px;margin-bottom:10px;border-left:3px solid var(--accent)}
.s-role strong{color:var(--accent);font-weight:600}

/* ===== Sections Frame ===== */
.sections-frame{margin-top:12px;border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;background:#fff}
.sections-frame-header{padding:8px 14px;background:#e8eaed;font-size:11px;font-weight:700;color:var(--text-sub);letter-spacing:.03em;display:flex;align-items:center;gap:6px;border-bottom:1px solid var(--border)}
.sections-frame-header .sf-icon{font-size:12px;opacity:.5}
.sections-frame-header .sf-count{margin-left:auto;font-weight:500;font-size:10px;color:var(--text-muted)}
.sections-frame-body{padding:8px}

/* ===== Section Block ===== */
.sec{margin-bottom:6px;border-radius:6px;overflow:hidden;background:var(--sec-bg)}
.sec-name{padding:7px 12px;font-size:11.5px;font-weight:700;color:var(--text-sub);background:var(--sec-head);display:flex;align-items:center;gap:6px}
.sec-name.has-cta{color:var(--cta)}
.sec-name.has-cta::before{content:'';display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--cta);flex-shrink:0}
.sec-name.has-exit{color:var(--accent)}
.sec-name .sec-tag{font-size:9px;padding:1px 5px;border-radius:3px;font-weight:700}
.sec-name .exit-from{margin-left:auto;font-size:10px;font-weight:700;color:#fff;background:var(--accent);padding:1px 7px;border-radius:3px}

.sec-items{padding:5px 12px 7px}

/* ATF boundary (制作向けのみ) */
.atf-line{margin:2px 0 6px;padding:0;display:flex;align-items:center;gap:8px;font-size:10px;color:var(--text-muted)}
.atf-line::before,.atf-line::after{content:'';flex:1;height:1px;background:repeating-linear-gradient(90deg,#b0b5be 0,#b0b5be 4px,transparent 4px,transparent 8px)}

/* Item styles */
.item{padding:4px 8px;margin:1px 0;font-size:12px;border-radius:4px;display:flex;align-items:flex-start;gap:7px;line-height:1.5}
.item .i-icon{min-width:12px;text-align:center;font-size:10px;margin-top:3px;flex-shrink:0}
.item .i-text{flex:1}
.item-cta{border-left:3px solid var(--cta);padding-left:8px;font-weight:700;color:var(--text)}
.item-cta .i-icon{color:var(--cta)}
.item-link{color:var(--text)}
.item-link .i-dest{color:var(--text-muted);font-size:10.5px;font-family:'SF Mono',Menlo,monospace}
.item-link .i-icon{color:var(--accent)}
.item-ext{color:var(--text)}
.item-ext .i-dest{color:var(--text-muted);font-size:10.5px}
.item-ext .i-icon{color:var(--text-muted)}
.item-muted{color:var(--text-muted);font-size:11.5px}
.item-muted .i-icon{color:#bfc4cc}
.sec-placeholder{padding:5px 12px;font-size:11px;color:var(--text-muted)}

/* ===== Arrow ===== */
.f-arrow{padding:3px 0 3px 12px;display:flex;align-items:center;gap:7px;margin-bottom:2px}
.f-arrow .arr-icon{color:#aaa;font-size:14px}
.f-arrow .arr-text{font-size:10.5px;color:var(--text-sub);background:#e8eaed;padding:3px 9px;border-radius:4px}
.f-arrow .arr-from{font-size:9.5px;color:var(--text-muted);background:#f4f5f7;padding:2px 7px;border-radius:3px}

/* ===== CV Terminal ===== */
.cv-end{max-width:760px;margin-top:10px;padding:18px 22px;background:#f9eaea;border:1.5px solid var(--cta);border-radius:var(--radius);text-align:center}
.cv-end h3{font-size:15px;color:var(--cta);margin-bottom:3px;font-weight:800}
.cv-end p{font-size:11.5px;color:var(--text-muted)}

/* Off-flow banner */
.off-banner{max-width:760px;margin-bottom:16px;padding:10px 16px;background:#f7f6f0;border:1px solid #e8e5d8;border-radius:var(--radius);font-size:12px;color:#7a6c3a;display:flex;align-items:center;gap:8px}

/* CV Page info */
.cv-page-info{max-width:760px;padding:24px;background:#f9eaea;border:1.5px solid var(--cta);border-radius:var(--radius);text-align:center}
.cv-page-info h3{font-size:18px;color:var(--cta);margin-bottom:8px;font-weight:800}
.cv-page-info p{font-size:13px;color:var(--text-sub)}
.cv-page-info .cv-type{display:inline-flex;align-items:center;gap:6px;padding:6px 16px;border-radius:8px;font-size:14px;font-weight:700;color:#fff;background:var(--cta);margin-top:12px}
.cv-page-info.ext{background:#f8f4ea;border-color:#c68a00}
.cv-page-info.ext h3{color:#b47a00}
.cv-page-info.ext .cv-type{background:#c68a00}

/* Section structure for off-flow / CV */
.struct-box{max-width:760px;margin-top:20px}
.struct-box h3{font-size:14px;color:var(--text-sub);margin-bottom:12px}

/* Sticky CTA block */
.sticky-cta-block{border:1px dashed #ccc;border-radius:6px;overflow:hidden;margin-bottom:6px;background:#f6f7f9}
.sticky-cta-name{padding:7px 12px;font-size:11.5px;font-weight:700;color:var(--text-muted);background:#eaecef;display:flex;align-items:center;gap:6px;border-bottom:1px dashed #ddd}
.sticky-spec{padding:4px 12px 6px;font-size:10px;color:var(--text-muted);line-height:1.5}

/* Animation */
.f-step{opacity:0;transform:translateY(6px);animation:stepIn .3s ease forwards}
@keyframes stepIn{to{opacity:1;transform:translateY(0)}}

/* Responsive */
@media(max-width:768px){
  #sidebar{width:240px;min-width:240px}
  #content{padding:20px}
}
</style>
</head>
<body>
<div id="app">
<nav id="sidebar">
  <div id="sidebar-header">
    <h1>金光八尾 ページ役割フロー</h1>
    <p>全72ページ｜入口→ゴール推奨ルート</p>
  </div>
  <div id="search-box">
    <span class="icon">&#x1F50D;</span>
    <input type="text" id="search-input" placeholder="ページ名・URLで検索..." oninput="renderSidebar()">
  </div>
  <div id="page-list"></div>
</nav>
<div id="main">
  <div id="topbar">
    <div id="breadcrumb">ページを選択してください</div>
    <div class="legend">
      <div class="lg"><div class="lg-dot" style="background:var(--f-知る)"></div>知る</div>
      <div class="lg"><div class="lg-dot" style="background:var(--f-気になる)"></div>気になる</div>
      <div class="lg"><div class="lg-dot" style="background:var(--f-比べる)"></div>比べる</div>
      <div class="lg"><div class="lg-dot" style="background:var(--f-安心する)"></div>安心する</div>
      <div class="lg"><div class="lg-dot" style="background:var(--f-申し込む)"></div>申し込む</div>
    </div>
  </div>
  <div id="content">
    <div style="text-align:center;padding:80px 20px;color:#bbb">
      <div style="font-size:48px;margin-bottom:16px">&#x1F4C4;</div>
      <h2 style="font-size:18px;color:#999;margin-bottom:8px">ページを選択してください</h2>
      <p style="font-size:13px">左のサイドバーからページを選択すると、<br>ゴール（説明会予約）までの推奨フローが表示されます。<br>分岐があるページではタブで切替できます。</p>
    </div>
  </div>
</div>
</div>

<script>
// ==================== PAGE DATA ====================
// s: sections [{n:name, d:[items]}], f: funnel, r: role
// ni: nextId, na: nextAction (single path)
// br: branches [{l:label, sub:subtitle, ni:nextId, na:action}] (multi path)
// cv: is CV page, cvName, cvPriority, cvExt
// off: off-flow label (still shows sections), vc: via sticky CTA
// ei: exit section index, c: CTA section indices
const P = [
// ===== T1: TOP =====
{id:1,n:"総合TOP",u:"/",t:"トップページ型",f:"知る",
 r:"中学TOP or 高校TOPへの振り分け。第1ターゲット（中学受験保護者）に最適化",
 s:[
  {n:"FV（ファーストビュー）",d:["[画像] メインスライダー画像（全幅・3〜5枚ローテーション）","【説明会予約】ボタン → 説明会予約フォーム","【資料請求】ボタン → /request/","お知らせバー（重要なお知らせ） → /news/{id}/"]},
  {n:"ピックアップ",d:["[カード] サムネイル記事カード ×4枚（CMS動的）","各カード → 記事詳細ページ"]},
  {n:"お知らせ＆トピックス",d:["[タブ] お知らせ ｜ トピックス","お知らせ記事リンク ×5件 → /news/{id}/","トピックス記事リンク ×5件 → /topics/{id}/","「お知らせ一覧を見る」 → /news/","「トピックス一覧を見る」 → /topics/"]},
  {n:"中学校・高校 振り分けバナー",d:["[カード] 中学校バナー（大） → /junior/","[カード] 高等学校バナー（大） → /senior/"]},
  {n:"コース紹介",d:["中学S特進コースカード → /junior/course/s-tokushin/","中学特進コースカード → /junior/course/tokushin/","高校S特進コースカード → /senior/course/s-tokushin/","高校特進コースカード → /senior/course/tokushin/","高校総合進学コースカード → /senior/course/shingaku/","高校美術コースカード → /senior/course/art/"]},
  {n:"在校生の声",d:["[カード] スライダーカード ×3枚（体験記/インタビュー）","「合格体験記を見る」 → /career/voice/","「在校生の声を見る」 → /career/students/"]},
  {n:"進学実績",d:["東大○名 京大○名 国公立○名 ...（ハイライト数字）","「詳しい合格実績を見る」 → /career/results/"]},
  {n:"説明会・イベント",d:["[カード] イベントカード ×3枚 → /admission/event/","「すべてのイベントを見る」 → /admission/event/","【説明会を予約する】ボタン → 説明会予約フォーム"]},
  {n:"学校紹介",d:["「学校紹介を見る」 → /about/","「校長挨拶を読む」 → /about/greeting/","「バーチャル見学する」 → バーチャル見学 (外部)"]},
  {n:"アクセス",d:["[画像] 地図プレビュー","「詳しいアクセスを見る」 → /access/"]},
  {n:"最終ボタン",d:["【資料請求】ボタン → /request/","【説明会予約】ボタン → 説明会予約フォーム","【お問い合わせ】ボタン → /contact/"]}
 ],c:[0,7,10],ei:3,
 br:[
  {l:"中学受験保護者ルート",sub:"第1ターゲット（最重要）",ni:2,na:"中学校バナーをクリック"},
  {l:"高校受験生ルート",sub:"第2ターゲット",ni:3,na:"高等学校バナーをクリック"}
 ]},

{id:2,n:"中学校TOP",u:"/junior/",t:"トップページ型",f:"気になる",
 r:"コース詳細ページへ誘導。中学受験保護者がコース比較を始める起点",
 s:[
  {n:"FV（ファーストビュー）",d:["[画像] 中学校メインビジュアル","【説明会予約】ボタン → 説明会予約フォーム"]},
  {n:"学びの特色",d:["[画像] 教育特色の紹介テキスト＆画像","「詳しく見る」 → /junior/feature/"]},
  {n:"コース紹介",d:["[カード] S特進コースカード → /junior/course/s-tokushin/","[カード] 特進コースカード → /junior/course/tokushin/"]},
  {n:"在校生の声",d:["[カード] インタビューカード ×2枚","「もっと見る」 → /career/students/"]},
  {n:"学校生活",d:["[画像] 学校生活のイメージ写真","「学校生活を見る」 → /junior/schoollife/","「クラブブログを見る」 → /clubblog/?school=junior"]},
  {n:"入試情報",d:["説明会日程リンク → /junior/examination/event/","募集要項リンク → /junior/examination/application/","学費・諸経費リンク → /junior/examination/tuition/"]}
 ],c:[0],ei:2,
 br:[
  {l:"S特進コース",sub:"難関大学進学志向",ni:17,na:"S特進コースカードをクリック"},
  {l:"特進コース",sub:"幅広い進路に対応",ni:18,na:"特進コースカードをクリック"}
 ]},

{id:3,n:"高等学校TOP",u:"/senior/",t:"トップページ型",f:"気になる",
 r:"コース詳細ページへ誘導。4コースの選択を最重視",
 s:[
  {n:"FV（ファーストビュー）",d:["[画像] 高校メインビジュアル","【説明会予約】ボタン → 説明会予約フォーム"]},
  {n:"学びの特色",d:["[画像] 教育特色の紹介テキスト＆画像","「詳しく見る」 → /senior/feature/"]},
  {n:"コース紹介",d:["[カード] S特進コースカード → /senior/course/s-tokushin/","[カード] 特進コースカード → /senior/course/tokushin/","[カード] 総合進学コースカード → /senior/course/shingaku/","[カード] 美術コースカード → /senior/course/art/"]},
  {n:"進学実績",d:["東大○名 京大○名 国公立○名 ...（ハイライト数字）","「合格実績の詳細を見る」 → /career/results/"]},
  {n:"合格体験記・在校生の声",d:["[カード] 体験記/インタビューカード ×3枚","「すべての合格体験記を見る」 → /career/voice/","「在校生の声を見る」 → /career/students/"]},
  {n:"学校生活",d:["[画像] 学校生活のイメージ写真","「学校生活を見る」 → /senior/schoollife/","「クラブブログ」 → /clubblog/?school=senior"]},
  {n:"入試情報",d:["説明会日程リンク → /senior/examination/event/","募集要項リンク → /senior/examination/application/","学費・諸経費リンク → /senior/examination/tuition/"]}
 ],c:[0],ei:2,
 br:[
  {l:"S特進コース",sub:"最難関大学志向",ni:19,na:"S特進カードをクリック"},
  {l:"特進コース",sub:"難関大学志向",ni:20,na:"特進カードをクリック"},
  {l:"総合進学コース",sub:"多様な進路",ni:21,na:"総合進学カードをクリック"},
  {l:"美術コース",sub:"芸術系進路",ni:22,na:"美術カードをクリック"}
 ]},

// ===== T2: セクションハブ =====
{id:4,n:"中学コース紹介TOP",u:"/junior/course/",t:"セクションハブ型",f:"気になる",
 r:"各コース詳細への振り分け",
 s:[
  {n:"コースカード一覧",d:["[カード] S特進コース「詳細を見る」 → /junior/course/s-tokushin/","[カード] 特進コース「詳細を見る」 → /junior/course/tokushin/"]},
  {n:"ロードマップ",d:["中学→高校 コース接続図（テキスト＆図解）","高校S特進への接続リンク → /senior/course/s-tokushin/","高校特進への接続リンク → /senior/course/tokushin/"]},
  {n:"行動ボタン",d:["【説明会で詳しく聞く】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[2],ei:0,
 br:[
  {l:"S特進コース",sub:"難関大学進学志向",ni:17,na:"S特進コース「詳細を見る」"},
  {l:"特進コース",sub:"幅広い進路に対応",ni:18,na:"特進コース「詳細を見る」"}
 ]},

{id:5,n:"高校コース紹介TOP",u:"/senior/course/",t:"セクションハブ型",f:"気になる",
 r:"各コース詳細への振り分け",
 s:[
  {n:"コースカード一覧",d:["[カード] S特進「詳細を見る」 → /senior/course/s-tokushin/","[カード] 特進「詳細を見る」 → /senior/course/tokushin/","[カード] 総合進学「詳細を見る」 → /senior/course/shingaku/","[カード] 美術「詳細を見る」 → /senior/course/art/"]},
  {n:"行動ボタン",d:["【説明会で詳しく聞く】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[1],ei:0,
 br:[
  {l:"S特進コース",sub:"最難関大学志向",ni:19,na:"S特進「詳細を見る」"},
  {l:"特進コース",sub:"難関大学志向",ni:20,na:"特進「詳細を見る」"},
  {l:"総合進学コース",sub:"多様な進路",ni:21,na:"総合進学「詳細を見る」"},
  {l:"美術コース",sub:"芸術系進路",ni:22,na:"美術「詳細を見る」"}
 ]},

{id:6,n:"中学 学校生活",u:"/junior/schoollife/",t:"セクションハブ型",f:"気になる",
 ua:"学校生活の雰囲気に触れる",
 r:"サブページ（一日/行事/クラブ）への振り分け。学校の雰囲気に触れた保護者を説明会へ誘導",
 s:[
  {n:"サブページカード",d:["[カード] 金光八尾の一日 → /junior/schoollife/daily/","[カード] 年間行事 → /junior/schoollife/events/","[カード] クラブ活動 → /junior/schoollife/club/"]},
  {n:"行動ボタン",d:["「クラブブログを見る」 → /clubblog/?school=junior","「バーチャル見学」 → バーチャル見学 (外部)","【説明会・見学会に予約する】 → /event/reservation/"]}
 ],c:[1],ei:0,atf:1,exitSec:"サブページカード",
 br:[
  {l:"クラブ活動を経由",sub:"「部活が気になる」保護者",ni:27,na:"クラブ活動カードをクリック"},
  {l:"直接ゴールへ",sub:"「もう見に行きたい」保護者",ni:69,na:"「説明会予約」ボタンをクリック"}
 ]},

{id:7,n:"高校 学校生活",u:"/senior/schoollife/",t:"セクションハブ型",f:"気になる",
 ua:"学校生活の雰囲気に触れる",
 r:"サブページ（一日/行事/クラブ）への振り分け。学校の雰囲気に触れた保護者を説明会へ誘導",
 s:[
  {n:"サブページカード",d:["[カード] 金光八尾の一日 → /senior/schoollife/daily/","[カード] 年間行事 → /senior/schoollife/events/","[カード] クラブ活動 → /senior/schoollife/club/"]},
  {n:"行動ボタン",d:["「クラブブログを見る」 → /clubblog/?school=senior","「バーチャル見学」 → バーチャル見学 (外部)","【説明会・見学会に予約する】 → /event/reservation/"]}
 ],c:[1],ei:0,atf:1,exitSec:"サブページカード",
 br:[
  {l:"クラブ活動を経由",sub:"「部活が気になる」保護者",ni:28,na:"クラブ活動カードをクリック"},
  {l:"直接ゴールへ",sub:"「もう見に行きたい」保護者",ni:69,na:"「説明会予約」ボタンをクリック"}
 ]},

{id:8,n:"中学 入試情報",u:"/junior/examination/",t:"セクションハブ型",f:"申し込む",
 r:"説明会予約 or 募集要項閲覧。リピーター動線の入口",
 s:[
  {n:"重要お知らせ",d:["お知らせリンク → /news/{id}/"]},
  {n:"サブページカード",d:["[カード] 説明会・イベント → /junior/examination/event/","[カード] 募集要項 → /junior/examination/application/","[カード] 学費・諸経費 → /junior/examination/tuition/"]},
  {n:"在校生の声",d:["[カード] インタビューカード ×2枚 → /career/students/"]},
  {n:"行動ボタン",d:["【説明会を予約する】 → 説明会予約フォーム","【資料請求】 → /request/","【個別相談】 → /contact/"]}
 ],c:[3],ei:3,ni:69,na:"「説明会を予約する」CTA"},

{id:9,n:"高校 入試情報",u:"/senior/examination/",t:"セクションハブ型",f:"申し込む",
 r:"説明会予約 or 募集要項閲覧",
 s:[
  {n:"重要お知らせ",d:["お知らせリンク → /news/{id}/"]},
  {n:"サブページカード",d:["[カード] 説明会・イベント → /senior/examination/event/","[カード] 募集要項 → /senior/examination/application/","[カード] 学費・諸経費 → /senior/examination/tuition/"]},
  {n:"在校生の声",d:["[カード] インタビューカード ×2枚 → /career/students/"]},
  {n:"行動ボタン",d:["【説明会を予約する】 → 説明会予約フォーム","【資料請求】 → /request/","【個別相談】 → /contact/"]}
 ],c:[3],ei:3,ni:69,na:"「説明会を予約する」CTA"},

{id:10,n:"学校紹介TOP",u:"/about/",t:"セクションハブ型",f:"知る",
 r:"サブページへの振り分け。6年間の学びがCV動線に最も近い",
 s:[
  {n:"サブページカード 1行目",d:["[カード] 校長挨拶 → /about/greeting/","[カード] 建学精神・教育方針 → /about/spirit/","[カード] 6年間の学び → /about/roadmap/"]},
  {n:"サブページカード 2行目",d:["[カード] あゆみ・沿革 → /about/history/","[カード] 制服について → /about/uniform/","[カード] 教育環境・施設 → /about/facility/","[カード] デジタルパンフレット → /about/pamphlet/","[カード] アートギャラリー → /about/gallery/"]},
  {n:"バーチャルツアー",d:["[画像] 校舎プレビュー","「オンラインで学校を見学する」 → バーチャル見学 (外部)"]},
  {n:"行動ボタン",d:["【資料請求】 → /request/","【説明会予約】 → 説明会予約フォーム"]}
 ],c:[3],ei:0,ni:31,na:"6年間の学びカード"},

{id:11,n:"進路・実績TOP",u:"/career/",t:"セクションハブ型",f:"比べる",
 r:"合格実績 or 体験記閲覧。比較検討フェーズの入口",
 s:[
  {n:"サブページカード",d:["[カード] 合格実績 → /career/results/","[カード] 合格体験記 → /career/voice/","[カード] 在校生の声 → /career/students/","[カード] 卒業生メッセージ → /career/alumni/"]},
  {n:"体験記プレビュー",d:["[カード] 体験記カード ×2枚（抜粋） → /career/voice/"]},
  {n:"行動ボタン",d:["【説明会で進路指導を体験】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[2],ei:0,ni:35,na:"合格実績詳細カード"},

{id:12,n:"入試情報 統合版TOP",u:"/admission/",t:"セクションハブ型",f:"申し込む",
 r:"中学/高校入試への振り分け",
 s:[
  {n:"重要お知らせ",d:["お知らせリンク → /news/{id}/"]},
  {n:"サブページカード",d:["[カード] 中学校入試 → /admission/junior/","[カード] 高校入試 → /admission/senior/","[カード] 説明会・イベント → /admission/event/","[カード] 学費・奨学金 → /admission/tuition/","[カード] FAQ → /admission/faq/"]},
  {n:"直近イベント",d:["次回説明会: 20XX年X月X日（テキスト表示）","【予約する】ボタン → 説明会予約フォーム"]},
  {n:"行動ボタン",d:["【資料請求】 → /request/","【個別相談】 → /contact/"]}
 ],c:[2,3],ei:1,
 br:[
  {l:"中学入試ルート",sub:"中学受験保護者向け",ni:38,na:"中学校入試カードをクリック"},
  {l:"高校入試ルート",sub:"高校受験生向け",ni:39,na:"高校入試カードをクリック"}
 ]},

{id:13,n:"在校生・保護者TOP",u:"/students/",t:"セクションハブ型",f:"対象外",
 r:"在校生保護者がブックマーク利用。CV動線の対象外",off:"在校生・保護者向けページ",
 s:[
  {n:"よく使うメニュー",d:["スクールバス運行表ボタン → /students/schoolbus/","行事予定ボタン → /students/event/","気象警報情報ボタン → /students/warning/","各種証明書ボタン → /students/certificate/"]},
  {n:"お知らせ",d:["在校生向けお知らせ記事 ×5件 → /news/{id}/"]},
  {n:"ダウンロード",d:["書類①PDF [PDF]","書類②PDF [PDF]"]},
  {n:"関連リンク",d:["「学校生活」 → /junior/schoollife/ or /senior/schoollife/","「クラブブログ」 → /clubblog/"]}
 ],c:[]},

{id:14,n:"卒業生TOP",u:"/graduates/",t:"セクションハブ型",f:"対象外",
 r:"卒業生向け。証明書発行が主用途",off:"卒業生向けページ",
 s:[
  {n:"よく使うメニュー",d:["各種証明書発行リンク → /graduates/certificate/","同窓会情報リンク","採用情報リンク → /recruit/"]},
  {n:"関連リンク",d:["「卒業生メッセージ」 → /career/alumni/"]}
 ],c:[]},

// ===== T3: 詳細コンテンツ =====
{id:15,n:"中学 学びの特色",u:"/junior/feature/",t:"詳細コンテンツ型",f:"気になる",
 r:"コース詳細への興味喚起。少人数・放課後学習を訴求",
 s:[
  {n:"コンテンツ本文",d:["[画像] 教育特色の解説テキスト＆画像","少人数制・面倒見の良さの訴求","放課後学習環境（自習室20時まで）の紹介"]},
  {n:"関連リンク",d:["「コース紹介」 → /junior/course/","「進路実績」 → /career/results/"]},
  {n:"行動ボタン",d:["【説明会で授業を体験する】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[2],ei:1,ni:4,na:"コース紹介リンク"},

{id:16,n:"高校 学びの特色",u:"/senior/feature/",t:"詳細コンテンツ型",f:"気になる",
 r:"コース詳細への興味喚起",
 s:[
  {n:"コンテンツ本文",d:["[画像] 教育特色の解説テキスト＆画像","4コースの教育方針概要","進学実績との連携紹介"]},
  {n:"関連リンク",d:["「コース紹介」 → /senior/course/","「合格体験記」 → /career/voice/"]},
  {n:"行動ボタン",d:["【説明会予約】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[2],ei:1,ni:5,na:"コース紹介リンク"},

{id:17,n:"中学 S特進コース",u:"/junior/course/s-tokushin/",t:"詳細コンテンツ型",f:"比べる",
 r:"在校生の声を読む→説明会予約。動線の核心ページ",
 s:[
  {n:"FV",d:["[画像] コース名・キャッチコピー・メインビジュアル","コース概要テキスト（対象・目標・特色）"]},
  {n:"学びの流れ",d:["中学→高校 コース接続図（テキスト＆図解）","「高校S特進への接続」 → /senior/course/s-tokushin/"]},
  {n:"在校生の声",d:["[カード] インタビュー抜粋（写真＋テキスト）","「インタビュー詳細」 → /career/students/"]},
  {n:"合格体験記",d:["[カード] 体験記①抜粋 → /career/voice/","[カード] 体験記②抜粋 → /career/voice/"]},
  {n:"他コース比較",d:["「特進コースも見る」 → /junior/course/tokushin/"]},
  {n:"行動ボタン",d:["【このコースについて相談する】 → /contact/","【説明会に参加する】 → 説明会予約フォーム"]}
 ],c:[5],ei:2,ni:60,na:"インタビュー詳細リンク"},

{id:18,n:"中学 特進コース",u:"/junior/course/tokushin/",t:"詳細コンテンツ型",f:"比べる",
 r:"在校生の声を読む→説明会予約",
 s:[
  {n:"FV",d:["[画像] コース名・キャッチコピー・メインビジュアル","コース概要テキスト（対象・目標・特色）"]},
  {n:"学びの流れ",d:["「高校特進/総合進学への接続」 → /senior/course/tokushin/"]},
  {n:"在校生の声",d:["[カード] インタビュー抜粋","「インタビュー詳細」 → /career/students/"]},
  {n:"合格体験記",d:["[カード] 体験記抜粋 → /career/voice/"]},
  {n:"他コース比較",d:["「S特進コースも見る」 → /junior/course/s-tokushin/"]},
  {n:"行動ボタン",d:["【このコースについて相談する】 → /contact/","【説明会に参加する】 → 説明会予約フォーム"]}
 ],c:[5],ei:2,ni:60,na:"インタビュー詳細リンク"},

{id:19,n:"高校 S特進コース",u:"/senior/course/s-tokushin/",t:"詳細コンテンツ型",f:"比べる",
 r:"合格実績/体験記を読む→説明会予約。進学実績が高校受験層の関心No.1",
 s:[
  {n:"FV",d:["[画像] コース名・キャッチコピー・メインビジュアル","コース概要テキスト"]},
  {n:"進学実績",d:["主要大学合格数ハイライト","「合格実績の詳細」 → /career/results/"]},
  {n:"在校生の声",d:["[カード] インタビュー抜粋","「インタビュー詳細」 → /career/students/"]},
  {n:"合格体験記",d:["[カード] 体験記①抜粋 → /career/voice/","[カード] 体験記②抜粋 → /career/voice/"]},
  {n:"他コース比較",d:["「特進コース」 → /senior/course/tokushin/","「総合進学コース」 → /senior/course/shingaku/","「美術コース」 → /senior/course/art/"]},
  {n:"行動ボタン",d:["【説明会に参加する】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[5],ei:1,ni:35,na:"合格実績の詳細リンク"},

{id:20,n:"高校 特進コース",u:"/senior/course/tokushin/",t:"詳細コンテンツ型",f:"比べる",
 r:"合格実績/体験記を読む→説明会予約",
 s:[
  {n:"FV",d:["[画像] コース名・キャッチコピー・メインビジュアル"]},
  {n:"進学実績",d:["主要大学合格数ハイライト","「合格実績の詳細」 → /career/results/"]},
  {n:"在校生の声",d:["[カード] インタビュー抜粋","「インタビュー詳細」 → /career/students/"]},
  {n:"合格体験記",d:["[カード] 体験記抜粋 → /career/voice/"]},
  {n:"他コース比較",d:["「S特進コース」 → /senior/course/s-tokushin/","「総合進学コース」 → /senior/course/shingaku/","「美術コース」 → /senior/course/art/"]},
  {n:"行動ボタン",d:["【説明会に参加する】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[5],ei:1,ni:35,na:"合格実績の詳細リンク"},

{id:21,n:"高校 総合進学コース",u:"/senior/course/shingaku/",t:"詳細コンテンツ型",f:"比べる",
 r:"在校生の声を読む→説明会予約",
 s:[
  {n:"FV",d:["[画像] コース名・キャッチコピー・メインビジュアル"]},
  {n:"進学実績",d:["主要大学合格数ハイライト","「合格実績の詳細」 → /career/results/"]},
  {n:"在校生の声",d:["[カード] インタビュー抜粋","「インタビュー詳細」 → /career/students/"]},
  {n:"合格体験記",d:["[カード] 体験記抜粋 → /career/voice/"]},
  {n:"他コース比較",d:["「S特進コース」 → /senior/course/s-tokushin/","「特進コース」 → /senior/course/tokushin/","「美術コース」 → /senior/course/art/"]},
  {n:"行動ボタン",d:["【説明会に参加する】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[5],ei:2,ni:60,na:"インタビュー詳細リンク"},

{id:22,n:"高校 美術コース",u:"/senior/course/art/",t:"詳細コンテンツ型",f:"比べる",
 r:"ギャラリー/体験記を読む→説明会予約。独自性が高い",
 s:[
  {n:"FV",d:["[画像] コース名・キャッチコピー・メインビジュアル"]},
  {n:"在校生の声",d:["[カード] インタビュー抜粋","「インタビュー詳細」 → /career/students/"]},
  {n:"合格体験記",d:["[カード] 体験記抜粋 → /career/voice/"]},
  {n:"作品ギャラリー",d:["[画像] 作品サムネイル","「ギャラリーページ」 → /about/gallery/"]},
  {n:"他コース比較",d:["「S特進コース」 → /senior/course/s-tokushin/","「特進コース」 → /senior/course/tokushin/","「総合進学コース」 → /senior/course/shingaku/"]},
  {n:"行動ボタン",d:["【説明会に参加する】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[5],ei:1,ni:60,na:"インタビュー詳細リンク"},

{id:23,n:"中学 金光八尾の一日",u:"/junior/schoollife/daily/",t:"詳細コンテンツ型",f:"気になる",
 r:"学校の雰囲気を伝える→クラブ活動へ",
 s:[
  {n:"一日の流れ",d:["7:30登校 → 8:30授業 → 12:30昼食 → 15:30部活 ...（タイムライン形式）","[画像] 各時間帯のイメージ写真"]},
  {n:"関連リンク",d:["「年間行事」 → /junior/schoollife/events/","「クラブ活動」 → /junior/schoollife/club/"]}
 ],c:[],ei:1,ni:27,na:"クラブ活動リンク"},

{id:24,n:"高校 金光八尾の一日",u:"/senior/schoollife/daily/",t:"詳細コンテンツ型",f:"気になる",
 r:"学校の雰囲気を伝える→クラブ活動へ",
 s:[
  {n:"一日の流れ",d:["7:30登校 → 8:30授業 → 12:30昼食 → 15:30部活 ...（タイムライン形式）","[画像] 各時間帯のイメージ写真"]},
  {n:"関連リンク",d:["「年間行事」 → /senior/schoollife/events/","「クラブ活動」 → /senior/schoollife/club/"]}
 ],c:[],ei:1,ni:28,na:"クラブ活動リンク"},

{id:25,n:"中学 年間行事",u:"/junior/schoollife/events/",t:"詳細コンテンツ型",f:"気になる",
 r:"学校の雰囲気を伝える。コンテンツ閲覧後は追従CTAでCV誘導",
 s:[
  {n:"行事カレンダー",d:["4月入学式 → 5月体育祭 → 9月文化祭 → 3月卒業式 ...（月別カレンダー形式）","[画像] 各行事の写真"]},
  {n:"関連リンク",d:["「トピックス」 → /topics/","「学校生活TOP」 → /junior/schoollife/"]}
 ],c:[],ei:-1,vc:true,ni:69,na:"追従CTA「説明会予約」"},

{id:26,n:"高校 年間行事",u:"/senior/schoollife/events/",t:"詳細コンテンツ型",f:"気になる",
 r:"学校の雰囲気を伝える。コンテンツ閲覧後は追従CTAでCV誘導",
 s:[
  {n:"行事カレンダー",d:["4月入学式 → 5月体育祭 → 9月文化祭 → 3月卒業式 ...（月別カレンダー形式）","[画像] 各行事の写真"]},
  {n:"関連リンク",d:["「トピックス」 → /topics/","「学校生活TOP」 → /senior/schoollife/"]}
 ],c:[],ei:-1,vc:true,ni:69,na:"追従CTA「説明会予約」"},

{id:27,n:"中学 クラブ活動",u:"/junior/schoollife/club/",t:"詳細コンテンツ型",f:"気になる",
 r:"クラブブログへ誘導 or 説明会予約",
 s:[
  {n:"クラブ一覧",d:["サッカー / バスケ / テニス / 吹奏楽 / 美術 ...（約19クラブ）","[画像] 各クラブ活動写真"]},
  {n:"行動ボタン",d:["「クラブブログを見る」 → /clubblog/?school=junior","【学校見学で部活体験】 → 説明会予約フォーム"]}
 ],c:[1],ei:1,ni:69,na:"「学校見学で部活体験」CTA"},

{id:28,n:"高校 クラブ活動",u:"/senior/schoollife/club/",t:"詳細コンテンツ型",f:"気になる",
 r:"クラブブログへ誘導 or 説明会予約",
 s:[
  {n:"クラブ一覧",d:["サッカー / バスケ / テニス / 吹奏楽 / 美術 ...（約19クラブ）","[画像] 各クラブ活動写真"]},
  {n:"行動ボタン",d:["「クラブブログを見る」 → /clubblog/?school=senior","【学校見学で部活体験】 → 説明会予約フォーム"]}
 ],c:[1],ei:1,ni:69,na:"「学校見学で部活体験」CTA"},

{id:29,n:"校長挨拶",u:"/about/greeting/",t:"詳細コンテンツ型",f:"知る",
 r:"建学精神への関心を喚起",
 s:[
  {n:"コンテンツ本文",d:["[画像] 校長写真","校長挨拶テキスト（教育理念・メッセージ）"]},
  {n:"関連リンク",d:["「建学精神・教育方針」 → /about/spirit/","「学校紹介TOP」 → /about/"]}
 ],c:[],ei:1,ni:30,na:"建学精神リンク"},

{id:30,n:"建学精神・教育方針",u:"/about/spirit/",t:"詳細コンテンツ型",f:"知る",
 r:"学校理解の深化。コンテンツ閲覧後は追従CTAでCV誘導",
 s:[
  {n:"コンテンツ本文",d:["[画像] 建学精神の解説テキスト＆画像","教育方針・3つの柱（例）"]},
  {n:"関連リンク",d:["「沿革」 → /about/history/","「校長挨拶」 → /about/greeting/"]}
 ],c:[],ei:-1,vc:true,ni:69,na:"追従CTA「説明会予約」"},

{id:31,n:"6年間の学び",u:"/about/roadmap/",t:"詳細コンテンツ型",f:"気になる",
 r:"コース詳細ページへ誘導。中学受験保護者の訴求力が高い",
 s:[
  {n:"コース接続図",d:["中1─2─3 → 高1─2─3 （図解）","「中学S特進」 → /junior/course/s-tokushin/","「中学特進」 → /junior/course/tokushin/","「高校S特進」 → /senior/course/s-tokushin/","「高校特進」 → /senior/course/tokushin/","「高校総合進学」 → /senior/course/shingaku/"]},
  {n:"行動ボタン",d:["【説明会予約】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[1],ei:0,ni:17,na:"中学S特進リンク"},

{id:32,n:"あゆみ・沿革",u:"/about/history/",t:"詳細コンテンツ型",f:"知る",
 r:"信頼感の醸成。コンテンツ閲覧後は追従CTAでCV誘導",
 s:[
  {n:"コンテンツ本文",d:["沿革年表（年代順リスト）","[画像] 歴史写真"]},
  {n:"関連リンク",d:["「建学精神」 → /about/spirit/","「学校紹介TOP」 → /about/"]}
 ],c:[],ei:-1,vc:true,ni:69,na:"追従CTA「説明会予約」"},

{id:33,n:"制服について",u:"/about/uniform/",t:"詳細コンテンツ型",f:"気になる",
 r:"閲覧完結型。ゴールなし",off:"閲覧完結ページ（リンク要素なし）",
 s:[
  {n:"コンテンツ本文",d:["[画像] 制服写真（男女別・季節別）","デザイン解説テキスト","素材・機能性の説明"]},
  {n:"※リンク要素なし",d:["テキスト・画像のみのページ"]}
 ],c:[]},

{id:34,n:"デジタルパンフレット",u:"/about/pamphlet/",t:"詳細コンテンツ型",f:"申し込む",
 r:"資料請求（紙パンフ）",
 s:[
  {n:"パンフレットビューアー",d:["外部ビューアー埋め込み（issuu等） (外部)","ページめくり機能付きビューアー"]},
  {n:"行動ボタン",d:["【紙のパンフレットを請求する】 → /request/"]}
 ],c:[1],ei:1,ni:67,na:"「紙のパンフレットを請求する」CTA"},

{id:35,n:"合格実績",u:"/career/results/",t:"詳細コンテンツ型",f:"比べる",
 r:"合格体験記を読む→説明会予約。高校受験層の関心No.1ページ",
 s:[
  {n:"実績データ",d:["東大○名 京大○名 阪大○名 ...（年度別表）","国公立/私立別の合格数グラフ","過去3年間の推移"]},
  {n:"合格体験記リンク",d:["「先輩の体験談を読む」 → /career/voice/"]},
  {n:"行動ボタン",d:["【説明会で進路指導を体験】 → 説明会予約フォーム"]}
 ],c:[2],ei:1,ni:59,na:"「先輩の体験談を読む」リンク"},

{id:36,n:"中学 募集要項",u:"/junior/examination/application/",t:"詳細コンテンツ型",f:"申し込む",
 r:"PDF閲覧→説明会予約",
 s:[
  {n:"募集要項データ",d:["試験日程・出願資格・選考方法 等（テキスト表形式）","募集要項PDF ダウンロード [PDF]"]},
  {n:"行動ボタン",d:["【説明会予約】 → 説明会予約フォーム","【お問い合わせ】 → /contact/"]}
 ],c:[1],ei:1,ni:69,na:"「説明会予約」CTA"},

{id:37,n:"高校 募集要項",u:"/senior/examination/application/",t:"詳細コンテンツ型",f:"申し込む",
 r:"PDF閲覧→説明会予約",
 s:[
  {n:"募集要項データ",d:["試験日程・出願資格・選考方法 等（テキスト表形式）","募集要項PDF ダウンロード [PDF]"]},
  {n:"行動ボタン",d:["【説明会予約】 → 説明会予約フォーム","【お問い合わせ】 → /contact/"]}
 ],c:[1],ei:1,ni:69,na:"「説明会予約」CTA"},

{id:38,n:"統合版 中学入試",u:"/admission/junior/",t:"詳細コンテンツ型",f:"申し込む",
 r:"説明会/募集要項/学費への振り分け",
 s:[
  {n:"入試概要",d:["入試の流れ・ポイント等（テキスト）"]},
  {n:"関連リンク",d:["「説明会・イベント」 → /admission/event/","「募集要項」 → /junior/examination/application/","「学費・奨学金」 → /admission/tuition/"]},
  {n:"行動ボタン",d:["【説明会予約】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[2],ei:1,ni:63,na:"説明会・イベントリンク"},

{id:39,n:"統合版 高校入試",u:"/admission/senior/",t:"詳細コンテンツ型",f:"申し込む",
 r:"説明会/募集要項/学費への振り分け",
 s:[
  {n:"入試概要",d:["入試の流れ・ポイント等（テキスト）"]},
  {n:"関連リンク",d:["「説明会・イベント」 → /admission/event/","「募集要項」 → /senior/examination/application/","「学費・奨学金」 → /admission/tuition/"]},
  {n:"行動ボタン",d:["【説明会予約】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[2],ei:1,ni:63,na:"説明会・イベントリンク"},

{id:40,n:"中学 学費・諸経費",u:"/junior/examination/tuition/",t:"詳細コンテンツ型",f:"安心する",
 r:"不安解消→個別相談 or 説明会予約",
 s:[
  {n:"学費データ",d:["入学金 ¥XXX,XXX / 授業料 ¥XXX,XXX/年 / 施設費 ...（表形式）","奨学金制度の案内","「塾不要」「放課後20時まで自習室」のコスト訴求"]},
  {n:"行動ボタン",d:["【個別相談で詳しく聞く】 → /contact/","【資料請求】 → /request/"]}
 ],c:[1],ei:1,ni:68,na:"「個別相談で詳しく聞く」CTA"},

{id:41,n:"高校 学費・諸経費",u:"/senior/examination/tuition/",t:"詳細コンテンツ型",f:"安心する",
 r:"不安解消→個別相談 or 説明会予約",
 s:[
  {n:"学費データ",d:["入学金 ¥XXX,XXX / 授業料 ¥XXX,XXX/年 / 施設費 ...（表形式）","奨学金制度の案内","コース別学費の比較"]},
  {n:"行動ボタン",d:["【個別相談で詳しく聞く】 → /contact/","【資料請求】 → /request/"]}
 ],c:[1],ei:1,ni:68,na:"「個別相談で詳しく聞く」CTA"},

{id:42,n:"スクールバス運行表",u:"/students/schoolbus/",t:"詳細コンテンツ型",f:"対象外",
 r:"在校生保護者向け",off:"在校生・保護者向けページ",
 s:[
  {n:"時刻表データ",d:["路線別スクールバス時刻表（テキスト表形式）","路線図イメージ"]},
  {n:"ダウンロード",d:["時刻表PDF [PDF]"]}
 ],c:[]},

{id:43,n:"行事予定",u:"/students/event/",t:"詳細コンテンツ型",f:"対象外",
 r:"在校生保護者向け",off:"在校生・保護者向けページ",
 s:[
  {n:"カレンダー",d:["年間行事予定カレンダー（月別表示）"]},
  {n:"ダウンロード",d:["年間行事予定表PDF [PDF]"]}
 ],c:[]},

{id:44,n:"気象警報情報",u:"/students/warning/",t:"詳細コンテンツ型",f:"対象外",
 r:"在校生保護者向け",off:"在校生・保護者向けページ",
 s:[
  {n:"コンテンツ本文",d:["気象警報時の対応について（テキスト）","休校基準の説明","連絡方法の案内"]}
 ],c:[]},

{id:45,n:"各種証明書（在校生）",u:"/students/certificate/",t:"詳細コンテンツ型",f:"対象外",
 r:"在校生向け",off:"在校生向けページ",
 s:[
  {n:"案内テキスト",d:["各種証明書の発行手続きについて（テキスト）","申請方法・発行日数・費用"]},
  {n:"ダウンロード",d:["申請書PDF [PDF]"]}
 ],c:[]},

{id:46,n:"各種証明書（卒業生）",u:"/graduates/certificate/",t:"詳細コンテンツ型",f:"対象外",
 r:"卒業生向け",off:"卒業生向けページ",
 s:[
  {n:"案内テキスト",d:["卒業証明書等の発行手続きについて（テキスト）","郵送申請の方法・費用"]},
  {n:"ダウンロード",d:["申請書PDF [PDF]"]}
 ],c:[]},

{id:47,n:"学校評価・財務情報",u:"/evaluation/",t:"詳細コンテンツ型",f:"対象外",
 r:"情報公開義務",off:"法的要件ページ",
 s:[
  {n:"学校評価",d:["評価報告書PDF（年度別） [PDF]"]},
  {n:"財務情報",d:["財務諸表PDF [PDF]"]}
 ],c:[]},

{id:48,n:"採用情報",u:"/recruit/",t:"詳細コンテンツ型",f:"対象外",
 r:"求職者向け",off:"採用情報ページ",
 s:[
  {n:"コンテンツ本文",d:["教職員募集情報（テキスト）","募集職種・応募要件・選考フロー","連絡先・応募方法"]}
 ],c:[]},

{id:49,n:"個人情報保護方針",u:"/privacy/",t:"詳細コンテンツ型",f:"対象外",
 r:"法的要件",off:"法的要件ページ",
 s:[
  {n:"ポリシー本文",d:["個人情報保護方針（テキスト全文）","収集する情報・利用目的・管理体制"]}
 ],c:[]},

{id:50,n:"サイトポリシー",u:"/sitepolicy/",t:"詳細コンテンツ型",f:"対象外",
 r:"法的要件",off:"法的要件ページ",
 s:[
  {n:"ポリシー本文",d:["サイトポリシー（テキスト全文）","著作権・免責事項・推奨環境"]}
 ],c:[]},

{id:51,n:"いじめ防止基本方針",u:"/schoolpolicy/",t:"詳細コンテンツ型",f:"対象外",
 r:"法的要件",off:"法的要件ページ",
 s:[
  {n:"ポリシー本文",d:["いじめ防止基本方針（テキスト全文）","学校の取り組み・相談窓口"]}
 ],c:[]},

// ===== T4: 施設紹介 =====
{id:52,n:"教育環境・施設",u:"/about/facility/",t:"施設紹介型",f:"気になる",
 r:"バーチャルツアー or 見学予約",
 s:[
  {n:"施設写真",d:["[画像] 施設写真グリッド（クリックで拡大モーダル）","教室・図書館・自習室・体育館・グラウンド等"]},
  {n:"バーチャルツアー",d:["[画像] 校舎プレビュー","「オンラインで校舎を見学する」 → バーチャル見学 (外部)"]},
  {n:"行動ボタン",d:["【見学予約】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[2],ei:2,ni:69,na:"「見学予約」CTA"},

{id:53,n:"アートギャラリー",u:"/about/gallery/",t:"施設紹介型",f:"気になる",
 r:"作品閲覧→美術コースへの興味。追従CTAでCV誘導",
 s:[
  {n:"作品写真一覧",d:["[画像] 作品写真グリッド（クリックで拡大モーダル）","美術コース生徒の作品展示","年度別/ジャンル別の作品"]}
 ],c:[],ei:-1,vc:true,ni:69,na:"追従CTA「説明会予約」"},

// ===== T5: 記事一覧（リスト） =====
{id:54,n:"お知らせ一覧",u:"/news/",t:"記事一覧型",f:"対象外",
 r:"情報提供。CV動線上のページではない",off:"情報提供ページ（ニュース）",
 s:[
  {n:"カテゴリタブ",d:["[タブ] すべて ｜ 中学校 ｜ 高等学校 ｜ 学校全体 ｜ 入試関連","カテゴリ切替 → /news/?cat=X"]},
  {n:"記事リスト（10〜20件/ページ）",d:["記事タイトル1 ── 20XX.XX.XX → /news/{id}/","記事タイトル2 ── 20XX.XX.XX → /news/{id}/","記事タイトル3 ── 20XX.XX.XX → /news/{id}/","...（CMS動的）"]},
  {n:"ページネーション",d:["前へ / 1 / 2 / 3 / ... / 次へ → /news/?page=N"]}
 ],c:[]},

{id:55,n:"トピックス一覧",u:"/topics/",t:"記事一覧型",f:"気になる",
 r:"記事閲覧→学校への親近感形成",off:"情報提供ページ（トピックス）",
 s:[
  {n:"カテゴリタブ",d:["[タブ] すべて ｜ 中学校 ｜ 高等学校 ｜ 学校全体","カテゴリ切替 → /topics/?cat=X"]},
  {n:"記事リスト",d:["記事タイトル1 ── 20XX.XX.XX → /topics/{id}/","記事タイトル2 ── 20XX.XX.XX → /topics/{id}/","...（CMS動的）"]},
  {n:"ページネーション",d:["前へ / 1 / 2 / 3 / ... / 次へ → /topics/?page=N"]}
 ],c:[]},

{id:56,n:"記事詳細",u:"/news/{id}/",t:"記事一覧型",f:"気になる",
 r:"関連記事 or 一覧へ戻る",off:"情報提供ページ（記事詳細）",
 s:[
  {n:"パンくず",d:["TOP → /","お知らせ or トピックス → /news/ or /topics/"]},
  {n:"記事本文",d:["記事タイトル ── 20XX.XX.XX","本文テキスト...（CMS入稿）","本文内リンク（CMS任意） → 各ページ"]},
  {n:"前後ナビ",d:["「前の記事」 → /news/{prev-id}/","「次の記事」 → /news/{next-id}/"]},
  {n:"関連記事",d:["関連記事①タイトル → /news/{related-id}/","関連記事②タイトル → /news/{related-id}/","関連記事③タイトル → /news/{related-id}/"]},
  {n:"戻るリンク",d:["「一覧に戻る」 → /news/ or /topics/"]}
 ],c:[]},

// ===== T6: 記事一覧（カード） =====
{id:57,n:"クラブ活動ブログ",u:"/clubblog/",t:"記事一覧型（カード）",f:"気になる",
 r:"記事閲覧→学校生活のイメージ形成。追従CTAでCV誘導",
 s:[
  {n:"学校切替タブ",d:["[タブ] すべて ｜ 中学校 ｜ 高等学校","学校切替 → /clubblog/?school=X"]},
  {n:"クラブ絞込タブ",d:["サッカー / バスケ / テニス / 吹奏楽 ...（約19クラブ）","クラブ絞込 → /clubblog/?club=X"]},
  {n:"カードグリッド",d:["[カード] 記事カード ×6枚以上（写真＋タイトル＋日付）","各カード → /clubblog/{id}/"]},
  {n:"もっと見る",d:["「もっと見る」ボタン → Ajax動的読込 or ページネーション"]}
 ],c:[],ei:-1,vc:true,ni:69,na:"追従CTA「説明会予約」"},

{id:58,n:"ブログ記事詳細",u:"/clubblog/{id}/",t:"記事一覧型（カード）",f:"気になる",
 r:"同クラブ記事閲覧。追従CTAでCV誘導",
 s:[
  {n:"パンくず",d:["TOP → /","クラブ活動ブログ → /clubblog/"]},
  {n:"記事本文",d:["[画像] 記事写真","本文テキスト...（CMS入稿）","本文内リンク（CMS任意） → 各ページ"]},
  {n:"同クラブ最新記事",d:["最新記事①タイトル → /clubblog/{id}/","最新記事②タイトル → /clubblog/{id}/","最新記事③タイトル → /clubblog/{id}/"]},
  {n:"戻るリンク",d:["「クラブ活動ブログに戻る」 → /clubblog/"]}
 ],c:[],ei:-1,vc:true,ni:69,na:"追従CTA「説明会予約」"},

// ===== T7: 体験記 =====
{id:59,n:"合格体験記",u:"/career/voice/",t:"体験記・事例型",f:"比べる",
 r:"説明会予約（「自分の子もこうなれる」）。王道軸の最終プッシュ",
 s:[
  {n:"フィルター",d:["[タブ] S特進 ｜ 特進 ｜ 総合進学 ｜ 美術","コース別フィルター → /career/voice/?course=X","年度別フィルター → /career/voice/?year=X"]},
  {n:"体験記カード一覧",d:["[カード] 体験記A（写真＋コース＋大学名＋抜粋）","[カード] 体験記B","[カード] 体験記C","[カード] 体験記D","カード内コース名リンク（任意） → /senior/course/X/"]},
  {n:"行動ボタン",d:["【説明会で金光八尾を体験する】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[2],ei:2,ni:69,na:"「説明会で金光八尾を体験する」CTA"},

{id:60,n:"在校生の声",u:"/career/students/",t:"体験記・事例型",f:"比べる",
 r:"説明会予約（「実際の生活が見えた」）。王道軸の最終プッシュ",
 s:[
  {n:"フィルター",d:["[タブ] 中学校 ｜ 高等学校","学校種フィルター → /career/students/?school=X","コース別フィルター → /career/students/?course=X"]},
  {n:"インタビューカード一覧",d:["[カード] インタビューA（写真＋コース＋抜粋）","[カード] インタビューB","[カード] インタビューC"]},
  {n:"行動ボタン",d:["【説明会で在校生に話を聞く】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[2],ei:2,ni:69,na:"「説明会で在校生に話を聞く」CTA"},

{id:61,n:"卒業生メッセージ",u:"/career/alumni/",t:"体験記・事例型",f:"比べる",
 r:"信頼感→説明会予約",
 s:[
  {n:"卒業生インタビュー",d:["[画像] 卒業生写真","メッセージ本文（活躍の様子・母校への感謝等）"]},
  {n:"行動ボタン",d:["【説明会予約】 → 説明会予約フォーム","【資料請求】 → /request/"]}
 ],c:[1],ei:1,ni:69,na:"「説明会予約」CTA"},

// ===== T8: FAQ =====
{id:62,n:"よくある質問",u:"/admission/faq/",t:"FAQ型",f:"安心する",
 r:"不安解消→お問い合わせ or 説明会予約",
 s:[
  {n:"カテゴリ目次",d:["教育体制（アンカーリンク）","学習面（アンカーリンク）","進路面（アンカーリンク）","生活面（アンカーリンク）","入試関係（アンカーリンク）"]},
  {n:"Q&A本文",d:["▼ 教育体制について","Q: 少人数制の具体的なクラスサイズは？ → A: ...","Q: 塾に通わなくても大丈夫？ → A: ...","▼ 生活面について","Q: いじめ対策は？ → A: ...","回答内リンク（任意） → 各ページ"]},
  {n:"行動ボタン",d:["【お問い合わせ】 → /contact/","【個別相談を予約する】 → 説明会予約フォーム"]}
 ],c:[2],ei:2,ni:69,na:"「個別相談を予約する」CTA"},

// ===== T9: イベント =====
{id:63,n:"説明会・イベント一覧",u:"/admission/event/",t:"イベント情報型",f:"申し込む",
 r:"説明会予約。最短2ステップでCVに到達",
 s:[
  {n:"学校切替タブ",d:["[タブ] すべて ｜ 中学校 ｜ 高等学校","学校切替 → /admission/event/?school=X"]},
  {n:"スケジュール表",d:["X月X日  学校説明会","【予約する】ボタン → 説明会予約フォーム","X月X日  オープンスクール","X月X日  入試説明会","※各イベントに「何が体験できるか」を明記"]},
  {n:"過去レポート",d:["レポート記事（任意） → /topics/{id}/"]},
  {n:"行動ボタン",d:["【資料請求】 → /request/","【個別相談】 → /contact/"]}
 ],c:[1,3],ei:1,ni:69,na:"「予約する」CTA"},

{id:64,n:"中学 説明会・イベント",u:"/junior/examination/event/",t:"イベント情報型",f:"申し込む",
 r:"説明会予約",
 s:[
  {n:"スケジュール表",d:["X月X日  学校説明会","【予約する】ボタン → 説明会予約フォーム","X月X日  オープンスクール"]},
  {n:"行動ボタン",d:["【資料請求】 → /request/","【お問い合わせ】 → /contact/"]}
 ],c:[0,1],ei:0,ni:69,na:"「予約する」CTA"},

{id:65,n:"高校 説明会・イベント",u:"/senior/examination/event/",t:"イベント情報型",f:"申し込む",
 r:"説明会予約",
 s:[
  {n:"スケジュール表",d:["X月X日  学校説明会","【予約する】ボタン → 説明会予約フォーム","X月X日  オープンスクール"]},
  {n:"行動ボタン",d:["【資料請求】 → /request/","【お問い合わせ】 → /contact/"]}
 ],c:[0,1],ei:0,ni:69,na:"「予約する」CTA"},

{id:66,n:"学費・奨学金 統合版",u:"/admission/tuition/",t:"イベント情報型",f:"安心する",
 r:"不安解消→個別相談",
 s:[
  {n:"学校切替タブ",d:["[タブ] 中学校 ｜ 高等学校","学校切替 → /admission/tuition/?school=X"]},
  {n:"学費データ",d:["入学金・授業料・施設費・奨学金制度一覧（テキスト表形式）"]},
  {n:"行動ボタン",d:["【個別相談】 → /contact/","【資料請求】 → /request/"]}
 ],c:[2],ei:2,ni:68,na:"「個別相談」CTA"},

// ===== T10: フォーム =====
{id:67,n:"資料請求フォーム",u:"/request/",t:"フォーム型",f:"申し込む",
 r:"フォーム送信完了",cv:true,cvName:"資料請求",cvPriority:2,
 s:[
  {n:"入力フォーム",d:["[フォーム] 氏名 / メール / 電話番号 / 住所 / 学年"]},
  {n:"個人情報取扱い",d:["個人情報保護方針に同意するチェック → /privacy/"]},
  {n:"送信",d:["【資料を請求する】送信ボタン → 確認画面"]}
 ],c:[2]},

{id:68,n:"お問い合わせフォーム",u:"/contact/",t:"フォーム型",f:"申し込む",
 r:"フォーム送信完了",cv:true,cvName:"お問い合わせ",cvPriority:4,
 s:[
  {n:"入力フォーム",d:["[フォーム] 氏名 / メール / 電話番号 / お問い合わせ内容"]},
  {n:"個人情報取扱い",d:["個人情報保護方針に同意するチェック → /privacy/"]},
  {n:"送信",d:["【送信する】送信ボタン → 確認画面"]}
 ],c:[2]},

{id:69,n:"説明会予約",u:"mirai-compass（外部）",t:"外部サービス",f:"申し込む",
 r:"mirai-compass外部サービスで予約完了",cv:true,cvExt:true,cvName:"説明会予約",cvPriority:1,
 s:[
  {n:"外部予約フォーム",d:["mirai-compass外部サービスの予約フォーム","[フォーム] 氏名 / メール / 希望日程 / お子様の学年","※外部サイト（mirai-compass）へ遷移"]}
 ],c:[0]},

{id:70,n:"フォーム確認画面",u:"確認画面",t:"フォーム型",f:"申し込む",
 r:"確認→送信",off:"フォーム内部画面",
 s:[
  {n:"入力内容確認",d:["氏名: ○○ ○○ / メール: xxx@xxx / ...","※ この内容でよろしいですか？"]},
  {n:"アクション",d:["「修正する」ボタン → フォーム画面（戻る）","【送信する】ボタン → 完了画面"]}
 ],c:[1]},

{id:71,n:"フォーム完了画面",u:"完了画面",t:"フォーム型",f:"申し込む",
 r:"送信完了→TOPへ",off:"フォーム内部画面",
 s:[
  {n:"完了メッセージ",d:["送信が完了しました。ありがとうございます。","確認メールをお送りしました。"]},
  {n:"戻るリンク",d:["「TOPへ戻る」 → /"]}
 ],c:[]},

// ===== T11: アクセス =====
{id:72,n:"アクセス",u:"/access/",t:"アクセス・地図型",f:"安心する",
 r:"通学不安の解消→見学予約",
 s:[
  {n:"地図",d:["[画像] Googleマップ埋め込み","Google Maps（拡大・ルート検索） (外部)"]},
  {n:"交通アクセス情報",d:["近鉄「○○駅」より徒歩○分","スクールバス / 車でのアクセス"]},
  {n:"スクールバス",d:["「運行表を見る」 → /students/schoolbus/"]},
  {n:"行動ボタン",d:["【資料請求】 → /request/","【見学予約】 → 説明会予約フォーム"]}
 ],c:[3],ei:3,ni:69,na:"「見学予約」CTA"}
];

const TPL_GROUPS = [
  {name:"T1 トップページ型",ids:[1,2,3]},
  {name:"T2 セクションハブ型",ids:[4,5,6,7,8,9,10,11,12,13,14]},
  {name:"T3 詳細コンテンツ型",ids:[15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]},
  {name:"T4 施設紹介型",ids:[52,53]},
  {name:"T5 記事型",ids:[54,55,56,57,58]},
  {name:"T7 体験記・事例型",ids:[59,60,61]},
  {name:"T8 FAQ型",ids:[62]},
  {name:"T9 イベント情報型",ids:[63,64,65,66]},
  {name:"T10 フォーム型",ids:[67,68,69,70,71]},
  {name:"T11 アクセス型",ids:[72]}
];

const FUNNEL_COLORS = {
  "知る":"var(--f-知る)","気になる":"var(--f-気になる)","比べる":"var(--f-比べる)",
  "安心する":"var(--f-安心する)","申し込む":"var(--f-申し込む)"
};

// ==================== STATE ====================
let currentId = null;
let branchSelections = {};
let filterMode = "client"; // "client" | "production"

// ==================== HELPERS ====================
function getPage(id) { return P.find(p => p.id === id); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function funnelColor(f) { return FUNNEL_COLORS[f] || "#999"; }

function classifyItem(str) {
  if (str.startsWith("\u3010") || str.startsWith("【")) return "cta";
  if (str.includes("[PDF]")) return "pdf";
  if (str.includes("(外部)")) return "ext";
  if (str.startsWith("[画像]")) return "img";
  if (str.startsWith("[タブ]")) return "tab";
  if (str.startsWith("[カード]")) return "card";
  if (str.startsWith("[フォーム]")) return "form";
  if (str.includes(" → ")) return "link";
  return "text";
}

function isEssential(cls) { return cls === "cta" || cls === "link" || cls === "ext" || cls === "pdf"; }

function itemIcon(cls) {
  switch(cls) {
    case "cta": return "\u25CF";
    case "link": return "\u2192";
    case "ext": return "\u2197";
    case "pdf": return "\u2193";
    default: return "\u2022";
  }
}

function buildChain(startId) {
  const chain = [];
  const visited = new Set();
  let id = startId;
  while (id != null) {
    if (visited.has(id)) break;
    visited.add(id);
    const p = getPage(id);
    if (!p) break;
    chain.push(p);
    if (p.cv) break;
    if (p.br) {
      const bi = branchSelections[p.id] || 0;
      id = p.br[bi] ? p.br[bi].ni : null;
    } else {
      id = p.ni || null;
    }
  }
  return chain;
}

// ==================== RENDER ====================
function selectPage(id) {
  currentId = id;
  renderSidebar();
  renderContent();
  document.getElementById('content').scrollTop = 0;
}

function selectBranch(pageId, branchIdx) {
  branchSelections[pageId] = branchIdx;
  renderContent();
  document.getElementById('content').scrollTop = 0;
}

function setFilter(mode) {
  filterMode = mode;
  renderContent();
}

function renderSidebar() {
  const list = document.getElementById('page-list');
  const search = document.getElementById('search-input').value.toLowerCase();
  let html = '';
  TPL_GROUPS.forEach((g, gi) => {
    const pages = g.ids.map(getPage).filter(Boolean);
    const filtered = search ? pages.filter(p =>
      p.n.toLowerCase().includes(search) || p.u.toLowerCase().includes(search) || String(p.id).includes(search)
    ) : pages;
    if (search && filtered.length === 0) return;
    html += '<div class="tpl-group">';
    html += '<div class="tpl-header" onclick="toggleGroup(this)" data-g="'+gi+'">';
    html += '<span class="arrow">&#x25BC;</span> ' + esc(g.name);
    html += '</div>';
    html += '<div class="tpl-items" data-g="'+gi+'" style="max-height:2000px">';
    (search ? filtered : pages).forEach(p => {
      const active = p.id === currentId ? ' active' : '';
      const fc = funnelColor(p.f);
      html += '<div class="pg-item'+active+'" onclick="selectPage('+p.id+')">';
      html += '<span class="pg-num">'+String(p.id).padStart(2,'0')+'</span>';
      html += '<span class="pg-name">'+esc(p.n)+'</span>';
      html += '<span class="f-dot" style="background:'+fc+'"></span>';
      html += '</div>';
    });
    html += '</div></div>';
  });
  list.innerHTML = html;
}

function toggleGroup(el) {
  const g = el.dataset.g;
  const items = document.querySelector('.tpl-items[data-g="'+g+'"]');
  if (items.classList.contains('collapsed')) {
    items.classList.remove('collapsed');
    el.classList.remove('collapsed');
  } else {
    items.classList.add('collapsed');
    el.classList.add('collapsed');
  }
}

function toggleStep(el) {
  const body = el.nextElementSibling;
  const toggle = el.querySelector('.s-toggle');
  body.classList.toggle('open');
  toggle.classList.toggle('open');
}

function renderFlowSummary(chain) {
  if (chain.length < 2) return '';
  const last = chain[chain.length-1];
  const steps = chain.length - 1;
  let h = '<div class="flow-summary">';
  h += '<div class="fs-label">保護者の体験ステップ</div>';
  h += '<div class="fs-journey">';
  chain.forEach((p, i) => {
    if (i > 0) h += '<span class="fs-arr">→</span>';
    h += p.cv
      ? '<span class="fs-goal">'+esc(p.n)+'</span>'
      : '<span class="fs-step">'+esc(p.n)+'</span>';
  });
  h += '</div>';
  if (last.cv) {
    h += '<div class="fs-why">'+steps+'クリックで「'+esc(last.cvName)+'」に到達。';
    const first = chain[0];
    if (first.f === "気になる") h += '学校の雰囲気を伝えて「見に行きたい」を逃さない設計です。';
    else if (first.f === "知る") h += '認知段階から行動までをスムーズにつなぐ設計です。';
    else if (first.f === "比べる") h += '比較段階の保護者を確実にゴールへ導く設計です。';
    else if (first.f === "安心する") h += '不安を解消しながらゴールへ導く設計です。';
    else if (first.f === "申し込む") h += '行動意欲の高い保護者を確実にゴールへ導く設計です。';
    h += '</div>';
  }
  h += '</div>';
  return h;
}

function renderContent() {
  const p = getPage(currentId);
  if (!p) return;
  const content = document.getElementById('content');
  const isClient = filterMode === "client";
  document.getElementById('breadcrumb').innerHTML =
    'P' + String(p.id).padStart(2,'0') + ' <b>' + esc(p.n) + '</b>';

  let html = '';

  // Page header
  html += '<div class="page-head">';
  html += '<h2>P' + String(p.id).padStart(2,'0') + ' ' + esc(p.n);
  if (!isClient) html += ' <span class="url">' + esc(p.u) + '</span>';
  html += '</h2>';
  html += '<div class="meta">';
  html += '<span class="badge badge-tpl">' + esc(p.t) + '</span>';
  html += '<span class="badge badge-funnel" style="background:' + funnelColor(p.f) + '">' + esc(p.f) + '</span>';
  if (p.cv) html += '<span class="badge badge-cv">ゴール</span>';
  if (p.off) html += '<span class="badge" style="background:#f5f0dc;color:#7a6c3a">ゴール動線外</span>';
  if (p.br) html += '<span class="badge badge-branch">分岐あり</span>';
  html += '</div>';
  html += '<div class="role-box"><strong>このページの役割:</strong> ' + esc(p.r) + '</div>';
  html += '</div>';

  // Filter bar
  html += '<div class="filter-bar">';
  html += '<label>表示モード:</label>';
  html += '<div class="filter-pills">';
  html += '<div class="filter-pill'+(filterMode==="client"?' active':'')+'" onclick="setFilter(\'client\')">お客さま向け</div>';
  html += '<div class="filter-pill'+(filterMode==="production"?' active':'')+'" onclick="setFilter(\'production\')">制作向け</div>';
  html += '</div>';
  html += '<span class="filter-desc">'+(isClient?'行動ボタン・遷移先のみ表示':'全要素表示（画像・カード・テキスト含む）')+'</span>';
  html += '</div>';

  // CV page
  if (p.cv) {
    html += renderCVPage(p);
    html += renderSectionStructure(p);
    content.innerHTML = html;
    return;
  }

  // Off-flow page
  if (p.off && !p.ni && !p.br) {
    html += '<div class="off-banner">⚠ ゴール動線外のページ（' + esc(p.off) + '）─ 追従ボタン・グローバルナビからゴールページへの遷移は可能</div>';
    html += renderSectionStructure(p);
    content.innerHTML = html;
    return;
  }

  // Branch tabs
  if (p.br) {
    const bi = branchSelections[p.id] || 0;
    html += '<div class="branch-bar">';
    html += '<h4>↔ 保護者の行動パターン</h4>';
    html += '<div class="branch-tabs">';
    p.br.forEach((b, i) => {
      html += '<div class="branch-tab' + (i === bi ? ' active' : '') + '" onclick="selectBranch('+p.id+','+i+')">';
      html += '<span class="bt-label">' + esc(b.l) + '</span>';
      if (b.sub) html += '<span class="bt-sub">' + esc(b.sub) + '</span>';
      html += '</div>';
    });
    html += '</div></div>';
  }

  // Flow summary + timeline
  const chain = buildChain(p.id);
  html += renderFlowSummary(chain);
  html += renderFlowTimeline(chain);

  content.innerHTML = html;
}

function renderCVPage(p) {
  let h = '<div class="cv-page-info' + (p.cvExt ? ' ext' : '') + '">';
  h += '<h3>このページはゴール（コンバージョン）ページです</h3>';
  h += '<p>ユーザーフローの到達点。全ページからの行動ボタンがここに集まります。</p>';
  h += '<div class="cv-type">';
  if (p.cvExt) h += '🌐 ';
  h += esc(p.cvName) + '（ゴール優先度 第' + p.cvPriority + '位）</div>';
  if (p.cvExt) h += '<p style="margin-top:8px;font-size:11px;color:var(--text-muted)">mirai-compass外部サービスへ遷移</p>';
  h += '</div>';

  h += '<div style="max-width:760px;margin-top:20px">';
  h += '<h3 style="font-size:14px;color:var(--text-sub);margin-bottom:12px">🔗 このゴールページへの主な流入元</h3>';
  h += '<div style="display:flex;flex-wrap:wrap;gap:6px">';
  P.forEach(sp => {
    let linksHere = false;
    if (sp.ni === p.id && !sp.cv) linksHere = true;
    if (sp.br) sp.br.forEach(b => { if (b.ni === p.id) linksHere = true; });
    if (linksHere && sp.id !== p.id) {
      const fc = funnelColor(sp.f);
      h += '<div style="padding:4px 10px;border-radius:6px;font-size:11px;background:#f5f5f5;border:1px solid #e0e0e0;cursor:pointer" onclick="selectPage('+sp.id+')">';
      h += '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:'+fc+';margin-right:4px"></span>';
      h += 'P'+String(sp.id).padStart(2,'0')+' '+esc(sp.n);
      h += '</div>';
    }
  });
  h += '</div></div>';
  return h;
}

function renderSectionStructure(p) {
  const isClient = filterMode === "client";
  let h = '<div class="struct-box">';
  h += '<h3>ページ構成（セクション一覧）</h3>';
  p.s.forEach((sec, si) => {
    const isCta = p.c && p.c.includes(si);
    let nameClass = 'sec-name';
    if (isCta) nameClass += ' has-cta';

    const items = sec.d.map(d => ({text:d, cls:classifyItem(d)}));
    const visibleItems = isClient ? items.filter(it => isEssential(it.cls)) : items;

    h += '<div class="sec">';
    h += '<div class="'+nameClass+'">' + esc(sec.n);
    if (isCta) h += ' <span class="sec-tag" style="background:var(--cta);color:#fff">行動ボタン</span>';
    h += '</div>';
    h += '<div class="sec-items">';
    if (visibleItems.length === 0) {
      h += '<div class="sec-placeholder">テキスト・画像コンテンツ</div>';
    } else {
      visibleItems.forEach(it => { h += renderItem(it, isClient); });
    }
    h += '</div></div>';
  });
  h += '</div>';
  return h;
}

function renderItem(it, isClient) {
  let h = '';
  if (it.cls === "cta") {
    const ctaText = isClient ? it.text.split(" → ")[0] : it.text;
    h += '<div class="item item-cta"><span class="i-icon">'+itemIcon("cta")+'</span><span class="i-text">'+esc(ctaText)+'</span></div>';
  } else if (it.cls === "link") {
    const parts = it.text.split(" → ");
    h += '<div class="item item-link"><span class="i-icon">'+itemIcon("link")+'</span><span class="i-text">'+esc(parts[0]);
    if (!isClient && parts[1]) h += ' <span class="i-dest">→ '+esc(parts[1])+'</span>';
    h += '</span></div>';
  } else if (it.cls === "ext") {
    const parts = it.text.split(" → ");
    h += '<div class="item item-ext"><span class="i-icon">'+itemIcon("ext")+'</span><span class="i-text">'+esc(parts[0]);
    if (!isClient && parts[1]) h += ' <span class="i-dest">→ '+esc(parts[1])+'</span>';
    h += '</span></div>';
  } else if (it.cls === "pdf") {
    h += '<div class="item item-link"><span class="i-icon">'+itemIcon("pdf")+'</span><span class="i-text">'+esc(it.text)+'</span></div>';
  } else {
    h += '<div class="item item-muted"><span class="i-icon">'+itemIcon("text")+'</span><span class="i-text">'+esc(it.text)+'</span></div>';
  }
  return h;
}

function renderSectionsFrame(p) {
  const secCount = p.s ? p.s.length : 0;
  let h = '<div class="sections-frame">';
  h += '<div class="sections-frame-header">';
  h += '<span class="sf-icon">&#9638;</span> ページ構成';
  h += '<span class="sf-count">'+secCount+'セクション</span>';
  h += '</div>';
  h += '<div class="sections-frame-body">';
  h += renderSections(p);
  h += '</div></div>';
  return h;
}

function renderSections(p) {
  const isClient = filterMode === "client";
  let h = '';
  p.s.forEach((sec, si) => {
    const isCta = p.c && p.c.includes(si);
    const isExit = si === p.ei;

    const items = sec.d.map(d => ({text:d, cls:classifyItem(d)}));
    const essentialItems = items.filter(it => isEssential(it.cls));
    const visibleItems = isClient ? essentialItems : items;

    if (visibleItems.length === 0 && !isCta && !isExit && isClient) {
      h += '<div class="sec"><div class="sec-name">'+esc(sec.n)+'</div>';
      h += '<div class="sec-placeholder">テキスト・画像コンテンツ</div></div>';
      return;
    }

    let nameClass = 'sec-name';
    if (isCta) nameClass += ' has-cta';
    if (isExit) nameClass += ' has-exit';

    h += '<div class="sec"><div class="'+nameClass+'">'+esc(sec.n);
    if (isCta) h += ' <span class="sec-tag" style="background:var(--cta);color:#fff">行動ボタン</span>';
    if (isExit) h += ' <span class="exit-from">次のページへ</span>';
    h += '</div><div class="sec-items">';

    if (visibleItems.length === 0) {
      h += '<div class="sec-placeholder">テキスト・画像コンテンツ</div>';
    } else {
      visibleItems.forEach(it => { h += renderItem(it, isClient); });
    }
    h += '</div></div>';
  });
  return h;
}

function renderFlowTimeline(chain) {
  if (chain.length === 0) return '';
  const lastPage = chain[chain.length - 1];
  const reachesCV = lastPage.cv;
  const isClient = filterMode === "client";

  let h = '<div class="flow-box">';
  h += '<div class="flow-title">→ ゴール（説明会予約）までの推奨ルート <span class="cnt">';
  h += reachesCV ? (chain.length - 1) + 'クリックで到達' : chain.length + 'ページ';
  h += '</span></div>';

  h += '<div class="flow-tl">';
  chain.forEach((p, i) => {
    const isFirst = i === 0;
    const isLast = i === chain.length - 1;
    const isCV = p.cv;
    const delay = i * 0.08;

    h += '<div class="f-step' + (isFirst ? ' is-entry' : '') + (isCV ? ' is-cv' : '') + '" style="animation-delay:'+delay+'s">';
    const dotColor = funnelColor(p.f);
    h += '<div class="s-dot" style="background:'+dotColor+'"></div>';
    h += '<div class="s-card">';

    // Header
    h += '<div class="s-header" onclick="toggleStep(this)">';
    h += '<span class="s-num" style="background:'+dotColor+'">'+(i+1)+'</span>';
    h += '<span class="s-name">' + esc(p.n) + '</span>';
    if (isFirst) h += '<span class="entry-tag">入口</span>';
    if (isCV) h += '<span class="cv-tag' + (p.cvExt ? '' : '') + '">ゴール</span>';
    if (!isClient) h += '<span class="s-url">' + esc(p.u) + '</span>';
    h += '<span class="s-toggle' + (isFirst || isCV ? ' open' : '') + '">&#x25BC;</span>';
    h += '</div>';

    // Body
    h += '<div class="s-body' + (isFirst || isCV ? ' open' : '') + '">';
    h += '<div class="s-funnel"><span class="badge badge-funnel" style="background:'+dotColor+';font-size:10px">保護者の気持ち: ' + esc(p.f) + '</span>';
    if (p.off) h += ' <span style="font-size:10px;color:#7a6c3a;background:#f5f0dc;padding:1px 6px;border-radius:4px">ゴール動線外</span>';
    h += '</div>';

    // Role
    h += '<div class="s-role"><strong>役割:</strong> ' + esc(p.r) + '</div>';

    // Sections frame
    h += renderSectionsFrame(p);

    // Sticky CTA
    if (!p.cv) {
      h += '<div class="sticky-cta-block">';
      h += '<div class="sticky-cta-name">○ 追従ボタン（全ページ共通）</div>';
      h += '<div class="sec-items">';
      if (isClient) {
        h += '<div class="item item-cta"><span class="i-icon">●</span><span class="i-text">【説明会予約】追従ボタン</span></div>';
        h += '<div class="item item-cta"><span class="i-icon">●</span><span class="i-text">【資料請求】追従ボタン</span></div>';
      } else {
        h += '<div class="item item-cta"><span class="i-icon">●</span><span class="i-text">【説明会予約】追従ボタン → 説明会予約フォーム</span></div>';
        h += '<div class="item item-cta"><span class="i-icon">●</span><span class="i-text">【資料請求】追従ボタン → /request/</span></div>';
      }
      h += '</div>';
      if (!isClient) {
        h += '<div class="sticky-spec">実装形式: 画面下部固定バー（スティッキー）。高さ95px程度。スクロールしても常時表示。モバイルではボタンを縦並びに変更。</div>';
      }
      h += '</div>';
    }

    if (p.vc && !isClient) {
      h += '<div style="margin-top:4px;padding:4px 10px;font-size:10px;color:var(--text-muted);background:#f4f5f7;border-radius:4px;border-left:2px solid var(--accent)">※ このページは追従ボタン経由でゴールへ遷移</div>';
    }

    h += '</div>'; // s-body
    h += '</div>'; // s-card
    h += '</div>'; // f-step

    // Arrow
    if (!isLast) {
      let arrowText = '';
      if (p.br) {
        const bi = branchSelections[p.id] || 0;
        arrowText = p.br[bi] ? p.br[bi].na : '';
      } else {
        arrowText = p.na || '';
      }
      const exitSecName = (p.ei !== undefined && p.ei >= 0 && p.s[p.ei]) ? p.s[p.ei].n : '';
      h += '<div class="f-arrow">';
      h += '<span class="arr-icon">↓</span>';
      h += '<span class="arr-text">' + esc(arrowText) + '</span>';
      if (!isClient && exitSecName) h += '<span class="arr-from">← '+esc(exitSecName)+'セクション内</span>';
      h += '</div>';
    }
  });
  h += '</div>'; // flow-tl

  // CV Terminal
  if (reachesCV) {
    const cvPage = chain[chain.length - 1];
    h += '<div class="cv-end">';
    h += '<h3>' + esc(cvPage.cvName) + '（最重要ゴール）</h3>';
    h += '<p>' + (cvPage.cvExt ? 'mirai-compass外部サービスで予約完了' : 'フォーム送信で完了') + '</p>';
    h += '</div>';
  }

  h += '</div>'; // flow-box
  return h;
}

// ==================== INIT ====================
renderSidebar();
</script>
</body>
</html>
